<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>report</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="mac0422---ep2">MAC0422 - EP2</h1>
<div id="integrantes">
<h2 id="integrantes">Integrantes</h2>
</div>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Nome</th>
<th style="text-align: left;">NUSP</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Daniel Martinez</td>
<td style="text-align: left;">10297709</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pedro Paulo Bambace</td>
<td style="text-align: left;">10297668</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<div id="arquivos-criadosmodificados">
<h2 id="arquivos-criadosmodificados">Arquivos criados/modificados</h2>
</div>
<div id="visualizauxe7uxe3o-da-tabela-de-processos">
<h4 id="visualização-da-tabela-de-processos">Visualização da tabela de processos</h4>
<p><span id="visualizauxe7uxe3o-da-tabela-de-processos" label="visualizauxe7uxe3o-da-tabela-de-processos">[visualizauxe7uxe3o-da-tabela-de-processos]</span></p>
</div>
<ul>
<li><p><code>minix_os/usr/src/servers/is/dmp_kernel.c</code></p></li>
<li><p><code>minix_os/usr/src/servers/is/dmp.c</code></p></li>
<li><p><code>minix_os/usr/src/servers/is/proto.h</code></p></li>
<li><p><code>minix_os/usr/include/minix/callnr.h</code></p></li>
<li><p><code>minix_os/usr/src/include/minix/callnr.h</code></p></li>
</ul>
<div id="chamada-de-sistema-para-alterauxe7uxe3o-de-prioridade">
<h4 id="chamada-de-sistema-para-alteração-de-prioridade">Chamada de sistema para alteração de prioridade</h4>
<p><span id="chamada-de-sistema-para-alterauxe7uxe3o-de-prioridade" label="chamada-de-sistema-para-alterauxe7uxe3o-de-prioridade">[chamada-de-sistema-para-alterauxe7uxe3o-de-prioridade]</span></p>
</div>
<ul>
<li><p><code>minix_os/usr/include/sys/resource.h</code></p></li>
<li><p><code>minix_os/usr/src/lib/posix/priority.c</code></p></li>
<li><p><code>minix_os/usr/src/servers/pm/misc.c</code></p></li>
<li><p><code>minix_os/usr/src/servers/pm/proto.h</code></p></li>
<li><p><code>minix_os/usr/src/servers/pm/table.c</code></p></li>
<li><p><code>minix_os/usr/src/lib/syslib/sys_nice.c</code></p></li>
<li><p><code>minix_os/usr/src/include/minix/syslib.h</code></p></li>
<li><p><code>minix_os/usr/include/minix/syslib.h</code></p></li>
<li><p><code>minix_os/usr/include/minix/com.h</code></p></li>
<li><p><code>minix_os/usr/src/include/minix/com.h</code></p></li>
<li><p><code>minix_os/usr/src/kernel/system.c</code></p></li>
<li><p><code>minix_os/usr/src/kernel/system.h</code></p></li>
<li><p><code>minix_os/usr/src/kernel/kernel.h</code></p></li>
<li><p><code>minix_os/usr/src/kernel/system/Makefile</code></p></li>
<li><p><code>minix_os/usr/src/kernel/system/.depend</code></p></li>
<li><p><code>minix_os/usr/src/kernel/config.h</code></p></li>
<li><p><code>minix_os/usr/src/kernel/system/do_priority.c</code></p></li>
</ul>
<div id="outros">
<h4 id="outros">Outros</h4>
<p><span id="outros" label="outros">[outros]</span></p>
</div>
<ul>
<li><p><code>minix_os/usr/src/b</code> - Arquivo para automatizar o build</p></li>
<li><p><code>minix_os/root/teste.c</code> - Arquivo que testa a chamada implementada</p></li>
</ul>
<div id="detalhes-de-implementauxe7uxe3o">
<h2 id="detalhes-de-implementauxe7uxe3o">Detalhes de implementação</h2>
</div>
<div id="visualizauxe7uxe3o-da-tabela-de-processos-1">
<h3 id="visualizauxe7uxe3o-da-tabela-de-processos-1">Visualização da tabela de processos</h3>
</div>
<p>Nessa parte do EP, pegamos a tabela de processos através da chamada de sistema <code>sys_getproctab()</code> e a ordenamos em ordem decrescente de prioridade (na verdade, ordenamos em ordem crescente de p_priority, que quanto menor é, maior a prioridade do processo). Definimos que quando o usuário pressiona a tecla F4, imprimimos para cada processo dessa tabela as seguintes informações:</p>
<ul>
<li><p>nr do processo</p></li>
<li><p>Nome do processo</p></li>
<li><p>Prioridade de execução</p></li>
<li><p>PID do processo</p></li>
<li><p>Tempo de CPU</p></li>
<li><p>Tempo de Sistema</p></li>
<li><p>Endereço do ponteiro da pilha</p></li>
</ul>
<p>Para conseguir o PID do processo, foi implementada uma chamada de biblioteca <code>getpidfromnr()</code> que retorna o PID do processo dado seu nr. Ela executa a chamada de sistema <code>CHPRIORITY</code> do <em>Process Manager</em> como modo 1, que relaciona as tabelas de processos <code>mproc</code> e <code>proc</code> e retorna o PID do processo especificado.</p>
<p>Se houver mais processos que os que cabem na tela, eles serão exibidos na próxima vez que o usuário pressionar F4.</p>
<div id="chamada-de-sistema-para-alterauxe7uxe3o-de-prioridade-1">
<h3 id="chamada-de-sistema-para-alterauxe7uxe3o-de-prioridade-1">Chamada de sistema para alteração de prioridade</h3>
</div>
<p>Implementamos a chamada de biblioteca <code>chpriority()</code> como especificado no enunciado, que executa a mesma chamada de sistema <code>CHPRIORITY</code>, mas como modo 0. Esta verifica se a prioridade passada está entre <code>MAX_USER_Q</code> e <code>MIN_USER_Q</code>, que são as prioridades permitidas para um processo de usuário e também se o processo cujo PID foi passado é filho do processo que a chamou através do atributo <code>mp_parent</code> do processo. Em seguida, ela executa a chamada de <em>kernel</em> <code>sys_priority</code> para a alteração da prioridade. Essa chamada de <em>kernel</em> retira o processo da fila de execução, altera sua prioridade e prioridade máxima, e o coloca na nova fila.</p>
<p>Para retornar números negativos nem a utilização de <code>errno</code>, utilizamos a função <code>_taskcall()</code> no lugar da <code>_syscall()</code>.</p>
<div id="arquivo-de-teste">
<h3 id="arquivo-de-teste">Arquivo de teste</h3>
</div>
<p>Há um arquivo de teste em <code>/root/teste.c</code> que testa a chamada de sistema implementada nesse EP para três casos:</p>
<ul>
<li><p>Processo não-filho, onde o resultado esperado é -2</p></li>
<li><p>Prioridade inválida, onde o resultado esperado é -1</p></li>
<li><p>Prioridade válida para um processo filho, onde o resultado esperado é a mudança de prioridade de tal processo, retornando seu valor.</p></li>
</ul>
<p>Nesse último caso, utilizamos a chamada de sistema <code>fork()</code> para a criação de um processo filho, que fica somente espera 100 segundos e termina, enquanto o processo pai faz a chamada de sistema implementada, também esperando 100 segundos depois disso para que seja possível verificar se o valor realmente foi alterado na tabela de processos (pressionando F4).</p>
<div id="arquivo-de-build">
<h3 id="arquivo-de-build">Arquivo de build</h3>
</div>
<p>É um simples script que automatiza o processo de build. Ele executa o <code>make world</code> para compilar todas as partes do Minix, move a imagem de <em>kernel</em> gerada para <code>/boot/image/image_big</code> e se tudo der certo, reinicia o sistema automaticamente.</p>
</body>
</html>
